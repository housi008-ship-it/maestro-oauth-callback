<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Connecting to Airtable...</title>
  <link rel="stylesheet" href="callback-styles.css">
</head>
<body>
  <div class="container">
    <div id="loading-state" class="status-card">
      <div class="spinner"></div>
      <h2>Connecting...</h2>
      <p class="status-message">Completing your Airtable authorization</p>
    </div>

    <div id="success-state" class="status-card" style="display: none;">
      <div class="icon success-icon">✓</div>
      <h2>Success!</h2>
      <p class="status-message">Redirecting back to Figma...</p>
      <div class="instructions">
        <p><strong>If the redirect doesn't work automatically:</strong></p>
        <ol>
          <li>Switch back to Figma</li>
          <li>The plugin should now be connected</li>
          <li>You can close this browser window</li>
        </ol>
        <button id="manual-redirect-btn" class="primary-btn">Open Figma Manually</button>
      </div>
    </div>

    <div id="error-state" class="status-card error-card" style="display: none;">
      <div class="icon error-icon">✕</div>
      <h2>Connection Failed</h2>
      <p class="status-message">Unable to complete the authorization</p>
      <div id="error-details" class="error-message"></div>
      <button id="retry-btn" class="secondary-btn">Try Again</button>
    </div>
  </div>

  <script>
    (function() {
      // Parse URL parameters
      const urlParams = new URLSearchParams(window.location.search);
      const code = urlParams.get('code');
      const state = urlParams.get('state');
      const error = urlParams.get('error');
      const errorDescription = urlParams.get('error_description');

      // Configuration
      const AIRTABLE_CLIENT_ID = '52040bca-e95a-491f-9c94-5d1713a8a2af';
      const REDIRECT_URI = 'https://housi008-ship-it.github.io/maestro-oauth-callback/callback.html';

      // DOM elements
      const loadingState = document.getElementById('loading-state');
      const successState = document.getElementById('success-state');
      const errorState = document.getElementById('error-state');
      const errorDetails = document.getElementById('error-details');
      const manualRedirectBtn = document.getElementById('manual-redirect-btn');
      const retryBtn = document.getElementById('retry-btn');

      // Handle OAuth errors
      if (error) {
        showError(`OAuth Error: ${error}`, errorDescription || 'No additional details provided');
        return;
      }

      // Validate required parameters
      if (!code || !state) {
        showError('Missing Parameters', 'Authorization code or state parameter is missing');
        return;
      }

      // Exchange authorization code for tokens using PKCE
      exchangeCodeForTokens(code, state);

      async function exchangeCodeForTokens(code, state) {
        try {
          // Retrieve code_verifier from state (plugin stored it there)
          const codeVerifier = state.split('|')[1];
          if (!codeVerifier) {
            throw new Error('Missing code_verifier in state parameter');
          }

          console.log('[Callback] Exchanging code for tokens...');

          // Call Airtable token endpoint directly (PKCE - no backend needed!)
          const response = await fetch('https://airtable.com/oauth2/v1/token', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: new URLSearchParams({
              grant_type: 'authorization_code',
              code: code,
              redirect_uri: REDIRECT_URI,
              client_id: AIRTABLE_CLIENT_ID,
              code_verifier: codeVerifier,
            }).toString(),
          });

          if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.error_description || errorData.error || 'Token exchange failed');
          }

          const tokens = await response.json();
          console.log('[Callback] Tokens received successfully');

          // Build deep link to return to Figma
          const deepLink = `figma://auth-callback?access_token=${encodeURIComponent(tokens.access_token)}&refresh_token=${encodeURIComponent(tokens.refresh_token)}&expires_in=${tokens.expires_in}`;

          // Show success and redirect
          showSuccess(deepLink);

        } catch (error) {
          console.error('[Callback] Token exchange error:', error);
          showError('Token Exchange Failed', error.message);
        }
      }

      function showSuccess(deepLink) {
        loadingState.style.display = 'none';
        successState.style.display = 'block';

        // Attempt automatic redirect
        setTimeout(() => {
          window.location.href = deepLink;
        }, 1000);

        // Manual redirect button
        if (manualRedirectBtn) {
          manualRedirectBtn.onclick = () => {
            window.location.href = deepLink;
          };
        }
      }

      function showError(title, message) {
        loadingState.style.display = 'none';
        errorState.style.display = 'block';
        
        if (errorDetails) {
          errorDetails.innerHTML = `<strong>${title}</strong><br>${message}`;
        }

        if (retryBtn) {
          retryBtn.onclick = () => {
            window.location.href = window.location.origin + window.location.pathname;
          };
        }
      }
    })();
  </script>
</body>
</html>
