<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Connecting to Airtable...</title>
  <link rel="stylesheet" href="callback-styles.css">
</head>
<body>
  <div class="container">
    <div id="loading-state" class="status-card">
      <div class="spinner"></div>
      <h2>Connecting...</h2>
      <p class="status-message">Redirecting back to Figma...</p>
    </div>

    <div id="success-state" class="status-card" style="display: none;">
      <div class="icon success-icon">✓</div>
      <h2>Authorization Complete!</h2>
      <p class="status-message">Redirecting back to Figma...</p>
      <div class="instructions">
        <p><strong>If the redirect doesn't work automatically:</strong></p>
        <ol>
          <li>Switch back to Figma</li>
          <li>The plugin should complete the connection</li>
          <li>You can close this browser window</li>
        </ol>
        <button id="manual-redirect-btn" class="primary-btn">Open Figma Manually</button>
      </div>
    </div>

    <div id="error-state" class="status-card error-card" style="display: none;">
      <div class="icon error-icon">✕</div>
      <h2>Connection Failed</h2>
      <p class="status-message">Unable to complete the authorization</p>
      <div id="error-details" class="error-message"></div>
      <button id="retry-btn" class="secondary-btn">Try Again</button>
    </div>
  </div>

  <script>
    (function() {
      // Parse URL parameters
      const urlParams = new URLSearchParams(window.location.search);
      const code = urlParams.get('code');
      const state = urlParams.get('state');
      const error = urlParams.get('error');
      const errorDescription = urlParams.get('error_description');

      // DOM elements
      const loadingState = document.getElementById('loading-state');
      const successState = document.getElementById('success-state');
      const errorState = document.getElementById('error-state');
      const errorDetails = document.getElementById('error-details');
      const manualRedirectBtn = document.getElementById('manual-redirect-btn');
      const retryBtn = document.getElementById('retry-btn');

      // Handle OAuth errors
      if (error) {
        showError(`OAuth Error: ${error}`, errorDescription || 'No additional details provided');
        return;
      }

      // Validate required parameters
      if (!code || !state) {
        showError('Missing Parameters', 'Authorization code or state parameter is missing');
        return;
      }

      // Build deep link to pass code back to Figma
      // Figma will do the token exchange (it can make network requests without CORS)
      const deepLink = `figma://auth-callback?code=${encodeURIComponent(code)}&state=${encodeURIComponent(state)}`;

      console.log('[Callback] Redirecting to Figma with authorization code');
      
      // Show success and redirect
      showSuccess(deepLink);

      function showSuccess(deepLink) {
        loadingState.style.display = 'none';
        successState.style.display = 'block';

        // Attempt automatic redirect
        setTimeout(() => {
          window.location.href = deepLink;
        }, 500);

        // Manual redirect button
        if (manualRedirectBtn) {
          manualRedirectBtn.onclick = () => {
            window.location.href = deepLink;
          };
        }
      }

      function showError(title, message) {
        loadingState.style.display = 'none';
        errorState.style.display = 'block';
        
        if (errorDetails) {
          errorDetails.innerHTML = `<strong>${title}</strong><br>${message}`;
        }

        if (retryBtn) {
          retryBtn.onclick = () => {
            window.location.href = window.location.origin + window.location.pathname;
          };
        }
      }
    })();
  </script>
</body>
</html>
