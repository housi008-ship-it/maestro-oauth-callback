<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Connecting to Airtable...</title>
  <link rel="stylesheet" href="callback-styles.css">
</head>
<body>
  <div class="container">
    <div id="loading-state" class="status-card">
      <div class="spinner"></div>
      <h2>Connecting...</h2>
      <p class="status-message">Completing your Airtable authorization</p>
    </div>

    <div id="success-state" class="status-card" style="display: none;">
      <div class="icon success-icon">✓</div>
      <h2>Success!</h2>
      <p class="status-message">Redirecting back to Figma...</p>
      <div class="instructions">
        <p><strong>If the redirect doesn't work automatically:</strong></p>
        <ol>
          <li>Switch back to Figma</li>
          <li>The plugin should now be connected</li>
          <li>You can close this browser window</li>
        </ol>
        <button id="manual-redirect-btn" class="primary-btn">Open Figma Manually</button>
      </div>
    </div>

    <div id="error-state" class="status-card error-card" style="display: none;">
      <div class="icon error-icon">✕</div>
      <h2>Connection Failed</h2>
      <p class="status-message">Unable to complete the authorization</p>
      <div id="error-details" class="error-message"></div>
      <button id="retry-btn" class="secondary-btn">Try Again</button>
    </div>
  </div>

  <script>
    // Parse URL parameters
    const urlParams = new URLSearchParams(window.location.search);
    const code = urlParams.get('code');
    const state = urlParams.get('state');
    const error = urlParams.get('error');
    const errorDescription = urlParams.get('error_description');

    // Configuration - update this with your Airtable OAuth app details
    const AIRTABLE_CLIENT_ID = 'YOUR_CLIENT_ID'; // Replace with your client ID

    // DOM elements
    const loadingState = document.getElementById('loading-state');
    const successState = document.getElementById('success-state');
    const errorState = document.getElementById('error-state');
    const errorDetails = document.getElementById('error-details');
    const manualRedirectBtn = document.getElementById('manual-redirect-btn');
    const retryBtn = document.getElementById('retry-btn');

    // Handle OAuth errors
    if (error) {
      showError(`OAuth Error: ${error}`, errorDescription || 'No additional details provided');
      return;
    }

    // Validate required parameters
    if (!code || !state) {
      showError('Missing Parameters', 'Authorization code or state parameter is missing from the callback URL');
      return;
    }

    // Exchange authorization code for tokens using PKCE
    exchangeCodeForTokens(code, state);

    async function exchangeCodeForTokens(code, state) {
      try {
        // Retrieve code_verifier from state (plugin stored it there)
        const codeVerifier = state.split('|')[1];
        if (!codeVerifier) {
          throw new Error('Missing code_verifier in state parameter');
        }

        console.log('[OAuth] Exchanging code for tokens...');

        // Exchange code for tokens directly with Airtable (no backend needed!)
        const response = await fetch('https://airtable.com/oauth2/v1/token', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
          },
          body: new URLSearchParams({
            grant_type: 'authorization_code',
            code: code,
            redirect_uri: window.location.origin + window.location.pathname,
            client_id: AIRTABLE_CLIENT_ID,
            code_verifier: codeVerifier,
          }),
        });

        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.error_description || `HTTP ${response.status}: ${response.statusText}`);
        }

        const tokens = await response.json();
        
        console.log('[OAuth] Tokens received successfully');

        // Show success state
        loadingState.style.display = 'none';
        successState.style.display = 'block';

        // Create deep link with tokens in URL
        // This is safe for native apps - the URL is consumed immediately
        const deepLinkUrl = `figma://auth-callback?` +
          `access_token=${encodeURIComponent(tokens.access_token)}` +
          `&refresh_token=${encodeURIComponent(tokens.refresh_token)}` +
          `&expires_in=${encodeURIComponent(tokens.expires_in)}`;
        
        // Store deep link for manual redirect button
        manualRedirectBtn.onclick = () => {
          window.location.href = deepLinkUrl;
        };

        // Attempt automatic redirect after 1 second
        setTimeout(() => {
          window.location.href = deepLinkUrl;
        }, 1000);

        // If still here after 3 seconds, show manual button
        setTimeout(() => {
          manualRedirectBtn.style.display = 'inline-block';
        }, 3000);

      } catch (error) {
        console.error('Token exchange error:', error);
        showError('Token Exchange Failed', error.message);
      }
    }

    function showError(title, message) {
      loadingState.style.display = 'none';
      successState.style.display = 'none';
      errorState.style.display = 'block';
      
      const errorElement = errorState.querySelector('h2');
      if (errorElement) {
        errorElement.textContent = title;
      }
      
      errorDetails.textContent = message;
      
      retryBtn.onclick = () => {
        window.close();
      };
    }
  </script>
</body>
</html>
